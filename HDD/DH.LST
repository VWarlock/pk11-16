.MAIN.	MACRO V05.06R Friday 30-Aug-19 09:57
Table of contents

    3- 462	common definitions for bios monitor
.MAIN.	MACRO V05.06R Friday 30-Aug-19 09:57  Page 1


      1
      2
      3
      4		000207 				RET	= RETURN
      5		161120 				id.buff	= 161120	;адреса регистров винта, далее смещения
      6		000002 				id.err	= 2		;  wr. precomp cyl.
      7		000004 				id.scnt = 4		;  Sector count rg.
      8		000006 				id.snum = 6		;  Sector number rg.
      9		000010 				id.cnlo = 10		;  Cylinder addr lo.
     10		000012 				id.cnhi = 12		;  Cylinder addr hi.
     11		000014 				id.sdh	= 14		;  Sector:Disk:Head
     12		000016 				id.csr	= 16		;  Command & status reg
     13		177774 				id.irq	= -4		;  interrupt, 4th bit of the head number
     14									;   and software reset
     15		177134 				DHCSR	= 177134
     16		177136 				DHBUF	= 177136
     17		177130 				FDBUF	= 177130
     18		147134 				DH.CSR	= DHCSR - 30000
     19		147136 				DH.BUF	= DHBUF - 30000
     20		000240 				DHVEC	= 240
     21
     22						.includ	/p16/
.MAIN.	MACRO V05.06R Friday 30-Aug-19 09:57  Page 2


      1					.enabl  lc
      2					.enabl	ama
      3					.enabl  gbl
      4					.mcall	.push,.pop
.MAIN.	MACRO V05.06R Friday 30-Aug-19 09:57  Page 4
Common definitions for bios monitor

      2
.MAIN.	MACRO V05.06R Friday 30-Aug-19 09:57  Page 5
Common definitions for bios monitor

      1
      2	000000					.asect
      3		000000 				.=0
      4	000000	000240 				NOP
      5	000002	000576 				BR	FDB
      6		000042 				.=42
      7	000042	001000 				1000
      8		000400 				.=400
      9	000400	012701 	000447 		FDB:	MOV	#FDBOOT+3,R1	;номер устройства
     10	000404	012702 	177130 			MOV	#FDBUF,R2	;регистр HD-FD PROC
     11	000410	011200 				MOV	(R2),R0		;берем номер устройства cold-boot
     12	000412	042700 	177770 			BIC	#^C7,R0		;сбрасываем остальные биты
     13	000416	052700 	000010 			BIS	#10,R0		;для флопа
     14	000422	110021 				MOVB	R0,(R1)+	;устанавливаем номер устройства
     15	000424	024141 				CMP	-(R1),-(R1)	;R1 = FDBOOT
     16	000426	010112 			10$:	MOV	R1,(R2)		;загружаем процесс
     17	000430	105712 				TSTB	(R2)		;проверяем готовность
     18	000432	100375 				BPL	10$		;не готов
     19	000434	105762 	000001 			TSTB	1(R2)		;проверяем на ошибку
     20	000440	001372 				BNE	10$		;повторяем операцию
     21	000442	000556 				BR	START		;запускаем процесс
     22
     23	000444	000001 	000000 	001000 	FDBOOT:	1,0,1000,1000		;
	000452	001000
     24
     25		001000 				.=1000
     26
     27	001000				START:	NEWROM	#RCMD		;создаем и стартуем процесс
     28	001010	000137 	002524 			jmp	boot		;перегружаемся с винта
     29	001014	012700 	002154 		SPRC:	MOV	#RCMD,R0	;формируем блоки команд
     30	001020	012701 	002044 			MOV	#CMDBL,R1	;для чтения-записи сектора целиком
     31	001024	012702 	000004 			MOV	#4,R2		;- 4 блока
     32	001030	012103 			10$:	MOV	(R1)+,R3	;(на месте стартовой
     33	001032	012704 	000100 			MOV	#100,R4		;нерезидентной части процесса -
     34	001036	010320 			20$:	MOV	R3,(R0)+	;метка RCMD, которая
     35	001040	010320 				MOV	R3,(R0)+	;впоследствии затирается
     36	001042	010320 				MOV	R3,(R0)+	;ввиду ненужности)
     37	001044	010320 				MOV	R3,(R0)+
     38	001046	077405 				SOB	R4,20$
     39	001050	012720 	000207 			MOV	#207,(R0)+	;конец блока команд секторной операции
     40	001054	077213 				SOB	R2,10$
     41
     42	001056	005000 			INCMD:	CLR	R0
     43	001060	005001 				CLR	R1
     44	001062					WAITIN	#0
     45	001072	005700 				TST	R0
     46	001074	100770 				BMI	INCMD
     47	001076	005701 				TST	R1
     48	001100	100766 				BMI	INCMD
     49	001102	013702 	147136 			MOV	DH.BUF,R2	; ???????????????????????????????
     50	001106	006002 				ROR	R2		; ?  РАЗБОР ЗАПРОСА К ПРОЦЕССУ  ?
     51	001110	103004 				BCC	10$		; ???????????????????????????????
     52	001112					SETINT	#DHVEC
     53	001122	006302 			10$:	ASL	R2
     54	001124	012737 	000200 	147136 		MOV	#200,DH.BUF	;выставляем готовность
     55	001132	012737 	000200 	147134 		MOV	#200,DH.CSR	;по дефолту
     56	001140	004737 	001724 			CALL	RR		;подключаем адресное пр-во вызывавшего
.MAIN.	MACRO V05.06R Friday 30-Aug-19 09:57  Page 5-1
Common definitions for bios monitor

     57	001144	011237 	002032 			MOV	(R2),BLK	;разбираем элемент очереди ввода/вывода
     58	001150	012237 	001770 			MOV	(R2)+,BLOCK	;начальный блок
     59	001154	005037 	001772 			CLR	BLOCK+2		;старшее слово 32-битной ячейки
     60	001160	112237 	002040 			MOVB	(R2)+,OPCOD	;код операции: 0 чтение, 373 объем устройства
     61	001164	112201 				MOVB	(R2)+,R1	;код устройства DH0: DH1: etc
     62	001166	012237 	001776 			MOV	(R2)+,ADDR	;начальный адрес
     63	001172	012237 	001774 			MOV	(R2)+,ILEN	;длина в словах
     64	001176	042701 	177770 			BIC	#^C7,R1		;кодов разделов всего восемь
     65	001202	072127 	000003 			ASH	#3,R1		;преобразуем в смещение по табл. элементов
     66	001206	062701 	002054 			ADD	#PARTBL,R1	;выбираем элемент таблицы разделов
     67	001212	062137 	001770 			ADD	(R1)+,BLOCK	;прибавляем смещение по винту
     68	001216	005537 	001772 			ADC	BLOCK+2		;к номеру блока
     69	001222	062137 	001772 			ADD	(R1)+,BLOCK+2
     70	001226	012137 	002036 			MOV	(R1)+,PLEN	;объем раздела
     71	001232	113701 	002040 			MOVB	OPCOD,R1	;вспоминаем код операции
     72	001236	001412 				BEQ	RWB		;нуль - чтение/запись
     73	001240	122701 	000373 			CMPB	#373,R1		;373 - определение объема раздела
     74	001244	001304 				BNE	INCMD		;что-то иное - игнорируем
     75	001246	013702 	001776 			MOV	ADDR,R2		;возвращаем объем раздела по .spfun 373
     76	001252	004737 	001724 			CALL	RR		;подключаем адресное пр-во вызывавшего прц.
     77	001256	013712 	002036 			MOV	PLEN,(R2)	;кладем объем в буфер данных --//--
     78	001262	000675 				BR	INCMD
     79
     80	001264	004737 	001660 		RWB:	CALL	WAIT		; ??????????????????????????????????????
     81									; ?  ОБРАБОТКА ОПЕРАЦИЙ ЧТЕНИЯ-ЗАПИСИ  ?
     82	001270	013700 	002002 			MOV	MM,R0		; ??????????????????????????????????????
     83	001274	001407 				BEQ	10$
     84	001276	010065 	000004 			MOV	R0,ID.SCNT(R5)	;кол-во допустимых секторов
     85	001302	012765 	000306 	000016 		MOV	#306,ID.CSR(R5)	;врубаем multiple mode если можно
     86	001310	004737 	001660 			CALL	WAIT
     87	001314	005037 	002000 		10$:	CLR	RW
     88	001320	013704 	001774 			MOV	ILEN,R4		;разбираемся - чтение или запись
     89	001324	001553 				BEQ	90$	;игнорируем "пустую" операцию
     90	001326	100004 				BPL	20$	;хотят читать - пусть RW остается нулем
     91	001330	062737 	000002 	002000 		ADD	#2,RW	;флаг R/W - смещение по таблице кодов команд
     92	001336	005404 				NEG	R4	;делаем положительное кол-во слов из отрицательного
     93	001340	010401 			20$:	MOV	R4,R1	;определяем выход за пределы раздела
     94	001342	005301 				DEC	R1
     95	001344	072127 	177770 			ASH	#-10,R1
     96	001350	005201 				INC	R1
     97	001352	063701 	002032 			ADD	BLK,R1	;номер блока, следующего за последним в операции
     98	001356	023701 	002036 			CMP	PLEN,R1
     99	001362	103534 				BLO	90$	;превышаем - операция не производится
    100
    101	001364					dval	#blk	;вывод на индикатор
    102
    103	001374	110437 	002020 			MOVB	R4,WLEN	;кол-во слов последнего сектора операции
    104	001400	105004 				CLRB	R4
    105	001402	000304 				SWAB	R4
    106	001404	010400 				MOV	R4,R0	;кол-во целых секторов
    107	001406	005737 	002020 			TST	WLEN
    108	001412	001401 				BEQ	30$
    109	001414	005200 				INC	R0
    110	001416	010065 	000004 		30$:	MOV	R0,ID.SCNT(R5)	;кол/во блоков округленное до большего
    111	001422	013701 	001770 			MOV	BLOCK,R1
    112	001426	013700 	001772 			MOV	BLOCK+2,R0
    113	001432	071037 	002024 			DIV	SEC,R0
.MAIN.	MACRO V05.06R Friday 30-Aug-19 09:57  Page 5-2
Common definitions for bios monitor

    114	001436	005201 				INC	R1
    115	001440	010165 	000006 			MOV	R1,ID.SNUM(R5)	;номер начального сектора операции
    116	001444	010001 				MOV	R0,R1
    117	001446	005000 				CLR	R0
    118	001450	071037 	002026 			DIV	HEAD,R0
    119	001454	042701 	177740 			BIC	#177740,R1
    120	001460	052701 	000100 			BIS	#100,R1
    121	001464	010165 	000014 			MOV	R1,ID.SDH(R5)	;номер поверхности
    122	001470	010065 	000010 			MOV	R0,ID.CNLO(R5)	;мл байт номера цилиндра
    123	001474	000300 				SWAB	R0
    124	001476	010065 	000012 			MOV	R0,ID.CNHI(R5)	;ст байт номера цилиндра
    125	001502	005037 	002022 			CLR	BNUM		;счетчик блоков для переключения страниц RAM
    126	001506	013701 	002000 			MOV	RW,R1		;смещение по таблице команд чтение/запись
    127	001512	016165 	002004 	000016 		MOV	RCOM(R1),ID.CSR(R5)	;даем команду читать-писать
    128	001520	013702 	001776 			MOV	ADDR,R2		;начальный виртуальный адрес
    129	001524	004737 	001724 			CALL	RR		;получаем физический
    130	001530	005704 				TST	R4		;проверяем кол-во целых 8-кб кусков
    131	001532	001423 				BEQ	80$		;нету ни одного
    132	001534	004737 	001660 		60$:	CALL	WAIT		;ждем готовности винта
    133	001540	103445 				BCS	90$		;если ошибка завершаем операцию
    134	001542	004771 	002010 			CALL	@RWCOM(R1)	;прогоняем сектор целиком
    135	001546	005237 	002022 			INC	BNUM		;увеличиваем счетчик блоков
    136	001552	032737 	000017 	002022 		BIT	#17,BNUM	;дошли до конца 8кб куска?
    137	001560	001007 				BNE	70$		;нет
    138	001562	013737 	161224 	161222 		MOV	@#UR2,@#UR1	;только для ПК11/16
    139	001570	012337 	161224 			MOV	(R3)+,@#UR2	;проходим по адресному пространству
    140	001574	162702 	020000 			SUB	#20000,R2	;вызвавшего процесса
    141	001600	077423 			70$:	SOB	R4,60$
    142	001602	005737 	002020 		80$:	TST	WLEN	;если число блоков было целым
    143	001606	001422 				BEQ	90$	;завершаем операцию
    144	001610	004737 	001660 			CALL	WAIT
    145	001614	103417 				BCS	90$	;если ошибка
    146	001616	012704 	000400 			MOV	#400,R4
    147	001622	163704 	002020 			SUB	WLEN,R4
    148	001626	006304 				ASL	R4	;получаем смещение от начала блока команд
    149	001630	066104 	002010 			ADD	RWCOM(R1),R4
    150	001634	004714 				CALL	(R4)	;прогоняем оставшуюся часть сектора
    151	001636	005002 				CLR	R2
    152	001640	013704 	002020 			MOV	WLEN,R4
    153	001644	006304 				ASL	R4
    154	001646	066104 	002014 			ADD	TCCOM(R1),R4
    155	001652	004714 				CALL	(R4)	;обрабатываем остаток - для записи забиваем нулями
    156	001654	000137 	001056 		90$:	JMP	INCMD	;переходим на ожидание следующей команды процессу
    157
    158	001660	016500 	000016 		WAIT:	MOV	ID.CSR(R5),R0	;считываем состояние винта
    159	001664	142700 	177456 			BICB	#^C321,R0	;оставляем биты: BSY, DRDY, DSC, ERR
    160	001670	100773 				BMI	WAIT		;если BSY=1, ждем дальше
    161	001672	122700 	000120 			CMPB	#120,R0		;проверяем: DRDY=DSC=1, BSY=ERR=0
    162	001676	000241 				CLC			;сбрасываем флаг ошибки
    163	001700	001410 				BEQ	10$		;выходим по готовности без ошибки
    164	001702	006000 				ROR	R0		;проверяем бит ERR
    165	001704	103365 				BCC	WAIT		;ошибки нет - значит просто еще не готов
    166	001706	116500 	000002 			MOVB	ID.ERR(R5),R0	;берем код ошибки
    167	001712	110037 	147137 			MOVB	R0,DH.BUF+1	;кладем его в регистр
    168	001716	110037 	147135 			MOVB	R0,DH.CSR+1	;и еще одна копия
    169	001722	000207 			10$:	RET			;выходим: флаг C - признак ошибки
    170
.MAIN.	MACRO V05.06R Friday 30-Aug-19 09:57  Page 5-3
Common definitions for bios monitor

    171	001724	017703 	000100 		RR:	MOV	@CALLER,R3	;разбираемся с адресным пространством
    172	001730	062703 	000026 			ADD	#P.UR0,R3	;вызвавшего процесса
    173	001734	032702 	160000 		40$:	BIT	#160000,R2
    174	001740	001404 				BEQ	50$
    175	001742	005723 				TST	(R3)+
    176	001744	162702 	020000 			SUB	#20000,R2
    177	001750	000771 				BR	40$
    178	001752	062702 	020000 		50$:	ADD	#20000,R2
    179	001756	012337 	161222 			MOV	(R3)+,@#UR1
    180	001762	012337 	161224 			MOV	(R3)+,@#UR2
    181	001766	000207 				RET
    182
    183					;STOP:	BIS	#1,2(SP)
    184					;	RTI
    185
    186	001770				BLOCK:	.BLKW	2	;32 битный номер блока по винту
    187	001774	000000 			ILEN:	HALT	;исходная длина в словах
    188	001776	000000 			ADDR:	HALT	;нач адрес
    189	002000	000000 			RW:	HALT	;флаг чтения-записи
    190	002002	000000 			MM:	HALT	;флаг Multiple Mode (IDE Block Mode)
    191	002004	000041 			RCOM:	41	;код команды чтения
    192	002006	000061 			WCOM:	61	;код команды записи
    193	002010	002154 	003156 		RWCOM:	RCMD,WCMD	;адреса процедур чтения и записи
    194	002014	004160 	005162 		TCCOM:	TCMD,CCMD	;адреса: фиктивное чтение и дозапись нулями
    195
    196	002020	000000 			WLEN:	HALT	;положительная длина в словах
    197	002022	000000 			BNUM:	HALT	;номер блока по ходу операции
    198	002024	000000 			SEC:	HALT	;кол-во секторов на трек
    199	002026	000000 			HEAD:	HALT	;кол-во поверхностей
    200	002030	000000 			CALLER:	HALT	;указатель на указатель дескриптора вызвавшего процесса
    201	002032	000000 			BLK:	HALT	;номер начального блока операции
    202	002034	   140 	   012 			.BYTE	140,12
    203	002036	000000 			PLEN:	HALT	;размер раздела
    204	002040	000000 			OPCOD:	HALT	;код операции из элемента очереди ввода-вывода
    205	002042	161120 			HDADDR:	ID.buff	;начальный адрес блока регистров винта
    206	002044	011522 			CMDBL:	MOV	(R5),(R2)+	;коды команд операций: чтение
    207	002046	012215 				MOV	(R2)+,(R5)	;запись
    208	002050	005715 				TST	(R5)		;фиктивное чтение для остатка слов
    209	002052	010215 				MOV	R2,(R5)		;дозапись нулями конца последнего сектора
    210	002054	000001 	000000 	012000 	PARTBL:	1,0,12000,0		;таблица разделов
	002062	000000
    211	002064	012001 	000000 	047037 		12001,0,47037,0		; ????????????????????????????
	002072	000000
    212	002074	065040 	000000 	140240 		65040,0,140240,0	; ? формат таблицы разделов  ?
	002102	000000
    213	002104	061040 	000000 	004000 		61040,0,4000,0		; ? 1 и 2 слово - 32-битный  ?
	002112	000000
    214	002114	025300 	000001 	177777 		25300,1,177777,0	; ? номер начального блока   ?
	002122	000000
    215	002124	025300 	000002 	177777 		25300,2,177777,0	; ? 3 слово - длина в блоках ?
	002132	000000
    216	002134	055300 	000003 	133000 		55300,3,133000,0	; ? 4 слово - резерв         ?
	002142	000000
    217	002144	010300 	000004 	177777 		10300,4,177777,0	; ????????????????????????????
	002152	000000
    218
    219	002154	012706 	001000 		RCMD:	MOV	#1000,SP
.MAIN.	MACRO V05.06R Friday 30-Aug-19 09:57  Page 5-4
Common definitions for bios monitor

    220	002160	004537 	002510 			JSR	R5,MV		;копируем карту памяти HALT в USER
    221	002164	161230 	161210 	000003 		UR4,HR4,3
    222	002172	005737 	157136 			TST	@#DHBUF-20000	;проверяем: процесс уже запущен?
    223	002176	001413 				BEQ	10$		;нет
    224	002200					SETPRI	#1
    225	002210	013701 	100016 			MOV	RUNNING,R1	;запущен - самоуничтожаемся
    226	002214	162701 	000020 			SUB	#P.SP,R1
    227	002220	010137 	174054 			MOV	R1,@#174054	;suicide
    228	002224	000240 				NOP
    229	002226				10$:	GET4K	#1		;захватываем 4кб RAM для себя
    230	002236	010037 	161222 			MOV	R0,@#UR1	;подключаем ее
    231	002242	004537 	002510 			JSR	R5,MV		;копируем из RT в захваченную память
    232	002246	020000 	000000 	004000 		20000,0,4000
    233	002254	010037 	161220 			MOV	R0,@#UR0	;перебрасываем туда управление
    234	002260	013701 	100016 			MOV	RUNNING,R1
    235	002264	042761 	020000 	000026 		BIC	#20000,P.MASK-P.SP(R1)	;запрет прерывания пультом
    236	002272	062701 	000030 			ADD	#P.CPRC-P.SP,R1
    237	002276	010137 	002030 			MOV	R1,CALLER	;@адрес дескриптора вызывающего процесса
    238	002302	062701 	000010 			ADD	#P.NAME-P.CPRC,R1
    239	002306	004537 	002512 			JSR	R5,MV2		;копируем имя процесса в дескриптор
    240	002312	002546 	000010 			PRCNAM,10
    241	002316					PROREG	#TCSR		;захватываем регистр состояния
    242	002326					PROREG	#TBUF		;захватываем регистр команд
    243	002336	013705 	002042 			MOV	HDADDR,R5	;R5 - указатель на блок регистров
    244	002342	012765 	000016 	177774 		MOV	#16,ID.IRQ(R5)	;Resetим винт
    245	002350	012765 	000012 	177774 		MOV	#12,ID.IRQ(R5)
    246	002356	004737 	001660 			CALL	WAIT
    247	002362	012765 	000354 	000016 		MOV	#354,ID.CSR(R5)	;даем команду прочитать паспорт винта
    248	002370	004737 	001660 			CALL	WAIT
    249	002374	005715 				TST	(R5)		;пропускаем ненужное
    250	002376	005715 				TST	(R5)
    251	002400	005715 				TST	(R5)
    252	002402	011537 	002026 			MOV	(R5),HEAD	;количество поверхностей
    253	002406	005715 				TST	(R5)
    254	002410	005715 				TST	(R5)
    255	002412	011537 	002024 			MOV	(R5),SEC	;секторов на трек
    256	002416	012700 	000050 			MOV	#40.,R0
    257	002422	005715 				TST	(R5)
    258	002424	077002 				SOB	R0,.-2
    259	002426	012700 	002002 			MOV	#MM,R0
    260	002432	011510 				MOV	(R5),(R0)	;кол-во секторов IDE block mode
    261	002434	042720 	177400 			bic	#177400,(R0)+	;иногда установлен 15 бит
    262	002440	001405 				BEQ	20$
    263	002442	012720 	000304 			MOV	#304,(R0)+	;команды R/W multiple mode
    264	002446	012720 	000305 			MOV	#305,(R0)+
    265	002452	000404 				BR	30$
    266	002454	012720 	000041 		20$:	MOV	#41,(R0)+	;команды просто R/W
    267	002460	012720 	000061 			MOV	#61,(R0)+
    268	002464	012700 	000367 		30$:	MOV	#256.-9.,R0
    269	002470	005715 				TST	(R5)
    270	002472	077002 				SOB	R0,.-2
    271	002474					SETPRI	#27
    272	002504	000137 	001014 			JMP	SPRC		;передаем управление резидентной части
    273
    274	002510	012501 			MV:	MOV	(R5)+,R1	;процедура
    275	002512	012502 			MV2:	MOV	(R5)+,R2	;пересылки
    276	002514	012503 				MOV	(R5)+,R3	;массива
.MAIN.	MACRO V05.06R Friday 30-Aug-19 09:57  Page 5-5
Common definitions for bios monitor

    277	002516	012221 			10$:	MOV	(R2)+,(R1)+
    278	002520	077302 				SOB	R3,10$
    279	002522	000205 				RTS	R5
    280
    281	002524	000005 			BOOT:	RESET	;загрузчик системы с винта
    282	002526	012737 	002536 	177136 		MOV	#CMBOOT,@#DHBUF
    283	002534	005007 				CLR	PC
    284
    285	002536	000000 	000000 	000000 	CMBOOT:	0,0,0,400
	002544	000400
    286
    287	002546	   151 	   104 	   105 	PRCNAM:	.ASCII	/iDEAtA iNtERFACE/	;имя процесса
	002551	   101 	   164 	   101
	002554	   040 	   151 	   116
	002557	   164 	   105 	   122
	002562	   106 	   101 	   103
	002565	   105
    288	002566	177134 	177677 	000200 	TCSR:	.WORD	DHCSR, 177677, 200, 2000, 100000, 177777	;дескрипторы
	002574	002000 	100000 	177777
    289	002602	177136 	000000 	000000 	TBUF:	.WORD	DHBUF, 0, 0, 2000, 0, 177777	;регистров процесса
	002610	002000 	000000 	177777
    290
    291		003156 			WCMD 	= RCMD + 1002		;буфера под массивы команд
    292		004160 			TCMD 	= WCMD + 1002
    293		005162 			CCMD 	= TCMD + 1002
    294
    295		001000 				.END	START		;сам догадайся что это такое
Errors detected:  0

*** Assembler statistics


Work  file  reads: 0
Work  file writes: 0
Size of work file: 9748 Words  ( 39 Pages)
Size of core pool: 16640 Words  ( 65 Pages)
Operating  system: RT-11

Elapsed time: 00:00:00.09
DK:DH,DK:DH=DK:DH
